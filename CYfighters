#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h> // Pour la fonction sleep



typedef struct {
    char nom[50];
    char description[100];
    int tours_actif;
    int nb_recharge;
} technique_speciale;

typedef struct {
    char nom[50];
    int pv;
    int pvmax;
    int att;
    int def;
    int agi;
    int vit;
    technique_speciale spe1;
    technique_speciale spe2;
    technique_speciale spe3;
} personnage;

typedef struct {
    char nom[50];
    personnage membre1;
    personnage membre2;
    personnage membre3;
    int pv;
} equipe;


int pv_equipe(equipe equipe1) {
    return equipe1.membre1.pv + equipe1.membre2.pv + equipe1.membre3.pv;
}

void attaque(personnage *attaquant, personnage *cible) {
    afficher_animation_attaque(attaquant->nom, cible->nom); // Ajouter animation
    int degats = (attaquant->att / cible->def) + (attaquant->agi / 2);
    int pv_avant = cible->pv; // Stocker les PV initiaux pour comparaison
    cible->pv -= degats;
    if (cible->pv < 0) cible->pv = 0;

    // Afficher le changement de PV
    printf("ðŸ’” %s attaque %s et inflige %d dÃ©gÃ¢ts \n", attaquant->nom, cible->nom, degats);
    printf("PV de %s : %d --> %d\n", cible->nom, pv_avant, cible->pv);

    if (cible->pv == 0) {
        printf("â˜ ï¸ %s est mort(e) !\n", cible->nom);
    }
}



void creer_equipe(equipe *equipe, personnage *personnages, int taille) {
    
    printf("Entrez le nom de votre Ã©quipe : ");
    scanf(" %[^\n]", equipe->nom);

    printf("Choisissez 3 membres pour l'Ã©quipe %s :\n", equipe->nom);
    afficher_personnages_disponibles(personnages, taille);

    int choix[3];
    for (int i = 0; i < 3; i++) {
        printf("Choix du membre %d (1-%d) : ", i + 1, taille);
        scanf("%d", &choix[i]);
        while (choix[i] < 1 || choix[i] > taille) {
            printf("Choix invalide. RÃ©essayez : ");
            scanf("%d", &choix[i]);
        }
    }

    equipe->membre1 = personnages[choix[0] - 1];
    equipe->membre2 = personnages[choix[1] - 1];
    equipe->membre3 = personnages[choix[2] - 1];
    equipe->pv = pv_equipe(*equipe);
}



int combat(equipe equipe1, equipe equipe2, int mode) {
    int cible, choix, tour = 1;
    personnage *attaquant, *cible_personnage;

    /* Initialiser les PV totaux */
    equipe1.pv = pv_equipe(equipe1);
    equipe2.pv = pv_equipe(equipe2);

    while (equipe1.pv > 0 && equipe2.pv > 0) {
        clear_terminal(); // Nettoyer le terminal au dÃ©but de chaque tour
        printf("\n--- Tour %d ---\n", tour);
        printf("PV Ã‰quipe %s: %d | PV Ã‰quipe %s: %d\n", equipe1.nom, equipe1.pv, equipe2.nom, equipe2.pv);

        // Afficher la santÃ© des membres
        printf("Ã‰quipe %s:\n", equipe1.nom);
        if (mode >= 1 && equipe1.membre1.pv > 0){
        printf("  %s: %d/%d PV\n", equipe1.membre1.nom, equipe1.membre1.pv, equipe1.membre1.pvmax);
        }
        if (mode >= 2 && equipe1.membre2.pv > 0){
        printf("  %s: %d/%d PV\n", equipe1.membre2.nom, equipe1.membre2.pv, equipe1.membre2.pvmax);
        }
        if (mode == 3 && equipe1.membre3.pv > 0){ 
        printf("  %s: %d/%d PV\n", equipe1.membre3.nom, equipe1.membre3.pv, equipe1.membre3.pvmax);
        }
        
        printf("Ã‰quipe %s:\n", equipe2.nom);
        if (mode >= 1 && equipe2.membre1.pv > 0){
        printf("  %s: %d/%d PV\n", equipe2.membre1.nom, equipe2.membre1.pv, equipe2.membre1.pvmax);
        }
        if (mode >= 2 && equipe2.membre2.pv > 0){
        printf("  %s: %d/%d PV\n", equipe2.membre2.nom, equipe2.membre2.pv, equipe2.membre2.pvmax);
        }
        if (mode == 3 && equipe2.membre3.pv > 0){
        printf("  %s: %d/%d PV\n", equipe2.membre3.nom, equipe2.membre3.pv, equipe2.membre3.pvmax);
        }
        if (tour % 2) {
            printf("Au tour de l'Ã©quipe %s\n", equipe1.nom);
            attaquant = vitesse_equipe_membre(&equipe1);
            while (attaquant->pv <= 0) { // Sauter les personnages morts
                if (attaquant == &equipe1.membre1) {
                 attaquant = &equipe1.membre2;
                } else if (attaquant == &equipe1.membre2) {
                attaquant = &equipe1.membre3;
                } else { // Donc attaquant == membre3
              attaquant = &equipe1.membre1;
                }
            }
        }

       else {
    printf("Au tour de l'Ã©quipe %s\n", equipe2.nom);
    attaquant = vitesse_equipe_membre(&equipe2);
    while (attaquant->pv <= 0) { // Sauter les personnages morts
        if (attaquant == &equipe2.membre1) {
            attaquant = &equipe2.membre2;
        } else if (attaquant == &equipe2.membre2) {
            attaquant = &equipe2.membre3;
        } else { // Donc attaquant == membre3
            attaquant = &equipe2.membre1;
            }
        }
    }

      
        printf("Que voulez-vous faire ?\n");
        printf("1: Attaquer\n");
        printf("2: %s - %s\n", attaquant->spe1.nom, attaquant->spe1.description);
        printf("3: %s - %s\n", attaquant->spe2.nom, attaquant->spe2.description);
        printf("4: %s - %s\n", attaquant->spe3.nom, attaquant->spe3.description);
        if (scanf("%d", &choix) != 1) {
            printf("EntrÃ©e invalide. Tour ignorÃ©.\n");
            while (getchar() != '\n'); // Effacer l'entrÃ©e invalide
            continue;
        }

        if (choix == 1) {
            printf("Quelle cible ?\n");
            if (tour % 2) {
                if (mode >= 1 && equipe2.membre1.pv > 0){
                printf("1: %s\n", equipe2.membre1.nom);
                }
                if (mode >= 2 && equipe2.membre2.pv > 0){
                printf("2: %s\n", equipe2.membre2.nom);
                }
                if (mode == 3 && equipe2.membre3.pv > 0){
                printf("3: %s\n", equipe2.membre3.nom);
                }
                if (scanf("%d", &cible) != 1 || cible < 1 || cible > mode || 
                    (cible == 1 && equipe2.membre1.pv <= 0) || 
                    (cible == 2 && equipe2.membre2.pv <= 0) || 
                    (cible == 3 && equipe2.membre3.pv <= 0)) {
                    printf("Cible invalide. Tour ignorÃ©.\n");
                    while (getchar() != '\n'); // Effacer l'entrÃ©e invalide
                    continue;
                }
                cible_personnage = (cible == 1) ? &equipe2.membre1 :
                                   (cible == 2) ? &equipe2.membre2 : &equipe2.membre3;
            } else {
                if (mode >= 1 && equipe1.membre1.pv > 0){
                printf("1: %s\n", equipe1.membre1.nom);
                }
                if (mode >= 2 && equipe1.membre2.pv > 0){
                printf("2: %s\n", equipe1.membre2.nom);
                }
                if (mode == 3 && equipe1.membre3.pv > 0){
                printf("3: %s\n", equipe1.membre3.nom);
                }
                if (scanf("%d", &cible) != 1 || cible < 1 || cible > mode || 
                    (cible == 1 && equipe1.membre1.pv <= 0) || 
                    (cible == 2 && equipe1.membre2.pv <= 0) || 
                    (cible == 3 && equipe1.membre3.pv <= 0)) {
                    printf("Cible invalide. Tour ignorÃ©.\n");
                    while (getchar() != '\n'); // Effacer l'entrÃ©e invalide
                    continue;
                }
               if (cible == 1) {
                    cible_personnage = &equipe1.membre1;
            } else if (cible == 2) {
                    cible_personnage = &equipe1.membre2;
            } else { // Donc cible == 3
                    cible_personnage = &equipe1.membre3;
            }

            }
            attaque(attaquant, cible_personnage);
        } else if (choix == 2) {
            appliquer_special(&attaquant->spe1, attaquant, cible_personnage);
        } else if (choix == 3) {
            appliquer_special(&attaquant->spe2, attaquant, cible_personnage);
        } else if (choix == 4) {
            appliquer_special(&attaquant->spe3, attaquant, cible_personnage);
        } else {
            printf("Choix invalide. Tour ignorÃ©.\n");
            continue;
        }

        /* Recalculer les PV de l'Ã©quipe */
        equipe1.pv = pv_equipe(equipe1);
        equipe2.pv = pv_equipe(equipe2);
        tour++;
    }


    clear_terminal(); // Nettoyer le terminal avant d'afficher le rÃ©sultat final
    if (perso1->pv <= 0) {
        printf("%s a gagnÃ© !\n", perso2->nom);
        return 2;
    } else {
        printf("%s a gagnÃ© !\n", perso1->nom);
        return 1;
    }
}

    clear_terminal(); // Nettoyer le terminal avant d'afficher le rÃ©sultat final
    if (equipe1.pv <= 0) {
        printf("L'Ã©quipe %s a gagnÃ© !\n", equipe2.nom);
        return 2;
    } else {
        printf("L'Ã©quipe %s a gagnÃ© !\n", equipe1.nom);
        return 1;
    }
}

void afficher_menu_principal() {
    clear_terminal();
    printf("=====================================\n");
    printf("       WELCOME TO CY FIGHTERS     \n");
    printf("=====================================\n");
    printf("  Appuyez sur EntrÃ©e pour commencer  \n");
    printf("=====================================\n");
    getchar(); // Attendre que l'utilisateur appuie sur EntrÃ©e
}


oid afficher_animation_speciale(const char *attaquant, const char *cible, const char *type) {
    printf("\n");
    printf("   âœ¨ %s utilise %s sur %s !\n", attaquant, type, cible);
    if (strcmp(type, "Foudre") == 0) {
        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      âš¡             O\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
        sleep(1);

        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      âš¡  -->       O\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
        sleep(1);

        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      âš¡             ðŸ’¥\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
    } else if (strcmp(type, "Tortue") == 0) {
        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      ðŸ¢             O\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
        sleep(1);

        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      ðŸ¢  -->       O\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
        sleep(1);

        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      ðŸ¢             ðŸŒ\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
    } else {
        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      âœ¨             O\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
        sleep(1);

        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      âœ¨  -->       O\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
        sleep(1);

        printf("   [ %s ]       [ %s ]\n", attaquant, cible);
        printf("      âœ¨             ðŸ’¥\n");
        printf("     /|\\           /|\\\n");
        printf("     / \\           / \\\n");
    }
    sleep(1);
    printf("\n");
}
